#!/bin/bash

# =================================================================
#                         é…ç½®å€å¡Š
# =================================================================

# 1. æ¸…ç†æ§åˆ¶åƒæ•¸
# -----------------------------------------------------------------
# SKIP_CLEANUP: 
#   - éƒ¨ç½²æ™‚: è¨­ç½®ç‚º "0" (æœƒè‡ªå‹•æ¸…ç†)
#   - æœ¬åœ°é–‹ç™¼æ™‚: è¨­ç½®ç‚º "1" (æœƒè·³éæ¸…ç†ï¼Œä¿ç•™ç”Ÿæˆçš„ _index.md)
# -----------------------------------------------------------------
SKIP_CLEANUP="0"

# 2. _index.md æ¨¡æ¿å…§å®¹
# -----------------------------------------------------------------
# æ³¨æ„: 
#   - è«‹ä½¿ç”¨ \" ä¾†è½‰ç¾©é›™å¼•è™Ÿ
#   - _TITLE_ æœƒåœ¨è…³æœ¬ä¸­è¢«æ›¿æ›æˆå¯¦éš›çš„æ–‡ä»¶å¤¾åç¨±
# -----------------------------------------------------------------
INDEX_MD_TEMPLATE="---
# èœå–®ä¸­é¡¯ç¤ºçš„åç¨±
title: \"ğŸ“ _TITLE_\"
# èœå–®æ’åº
weight: 10
# è®“é€™å€‹ Section åƒ…ç”¨æ–¼æ‘ºç–Š
bookCollapseSection: true
---"

# =================================================================
#                         è…³æœ¬æ ¸å¿ƒé‚è¼¯
# =================================================================

# å…§éƒ¨æ¨™è¨˜ï¼šç”¨æ–¼è­˜åˆ¥è‡ªå‹•ç”Ÿæˆçš„æ–‡ä»¶ï¼Œé¿å…èª¤åˆªæ‰‹å‹•å‰µå»ºçš„å…§å®¹ã€‚
# ä½¿ç”¨ YAML è¨»é‡‹æ ¼å¼ (#)ï¼Œç¢ºä¿æ’å…¥åˆ° Front Matter å…§éƒ¨æ™‚ä¸æœƒå½±éŸ¿é…ç½®
readonly SIGNATURE="# Auto-generated by build.sh - Do not edit manually"

# --- å‡½æ•¸ï¼šç”Ÿæˆè‡¨æ™‚çš„ _index.md æ–‡ä»¶ ---
generate_indexes() {
    echo "â–¶ é–‹å§‹ç”Ÿæˆè‡¨æ™‚çš„ _index.md æ–‡ä»¶..."

    find content/ -type d -not -path "content" | while read dir; do
        
        # 1. æª¢æŸ¥è©²ç›®éŒ„æ˜¯å¦å·²å­˜åœ¨ _index.md
        if [ -f "$dir/_index.md" ]; then
            # æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³éç”Ÿæˆ
            continue
        fi

        # 2. æª¢æŸ¥è©²ç›®éŒ„ä¸‹ (ä¸åŒ…å«å­ç›®éŒ„) æ˜¯å¦å­˜åœ¨ä»»ä½• .md æ–‡ä»¶
        if ! find "$dir" -maxdepth 1 -type f -name "*.md" | grep -q '.\/.*\.md'; then
            continue
        fi
        
        # 3. è™•ç†æ–‡ä»¶ç”Ÿæˆ
        folder_name=$(basename "$dir")
        
        # A. æ›¿æ›æ¨¡æ¿ä¸­çš„æ¨™é¡Œä½”ä½ç¬¦
        # ä½¿ç”¨å¼•è™ŸåŒ…è£¹è®Šé‡ä»¥ä¿ç•™æ›è¡Œç¬¦
        content_with_title=$(echo "$INDEX_MD_TEMPLATE" | sed "s/_TITLE_/$folder_name/g")
        
        # B. å°‡ç°½åæ’å…¥åˆ° Front Matter å…§éƒ¨
        # é‚è¼¯ï¼šç§»é™¤å­—ä¸²æœ«å°¾çš„ "---" -> æ·»åŠ ç°½å -> åŠ å› "---"
        # ${var%pattern} æ˜¯ Bash ç§»é™¤å¾Œç¶´çš„èªæ³•
        content_body="${content_with_title%---}"
        
        # å¯«å…¥æœ€çµ‚å…§å®¹
        # æ³¨æ„ï¼šé€™è£¡æœƒå°‡ SIGNATURE æ”¾åœ¨å…§å®¹çš„æœ€å¾Œï¼Œç·Šè²¼è‘—æœ€å¾Œçš„ ---
        echo -e "${content_body}${SIGNATURE}\n---" > "$dir/_index.md"
    done
    echo "âœ… è‡¨æ™‚ _index.md æ–‡ä»¶ç”Ÿæˆå®Œç•¢ã€‚"
}

# --- å‡½æ•¸ï¼šæ¸…ç†è‡¨æ™‚çš„ _index.md æ–‡ä»¶ ---
cleanup_indexes() {
    # æª¢æŸ¥æ˜¯å¦è¨­ç½®äº†è·³éæ¸…ç†
    if [ "$SKIP_CLEANUP" == "1" ]; then
        echo "âš ï¸ SKIP_CLEANUP = 1ã€‚è·³éè‡¨æ™‚ _index.md æ–‡ä»¶çš„æ¸…ç†ã€‚"
        return 0
    fi
    
    echo "â–¶ åŸ·è¡Œæ¸…ç†è‡¨æ™‚ _index.md æ–‡ä»¶..."
    
    # æŸ¥æ‰¾æ‰€æœ‰ _index.md æ–‡ä»¶ä¸¦æª¢æŸ¥æ˜¯å¦åŒ…å«æ¨™è¨˜
    find content/ -type f -name "_index.md" | while read file; do
        # æŸ¥æ‰¾æ¨™è¨˜ä¸¦åˆªé™¤æ–‡ä»¶ (grep -F ç”¨æ–¼æŸ¥æ‰¾å›ºå®šå­—ç¬¦ä¸²ï¼Œä¸ä½¿ç”¨æ­£å‰‡)
        if grep -qF "$SIGNATURE" "$file"; then
            rm "$file"
        fi
    done
    
    echo "âœ… æ¸…ç†å®Œç•¢ã€‚"
}

# --- åŸ·è¡Œæµç¨‹ ---

# ç¢ºä¿åœ¨ä¸è·³éæ¸…ç†æ™‚ï¼Œè¨­ç½®é€€å‡ºé™·é˜± (Trap)
if [ "$SKIP_CLEANUP" != "1" ]; then
    trap cleanup_indexes EXIT
fi

# 1. ç”Ÿæˆ _index.md æ–‡ä»¶
generate_indexes

# 2. åŸ·è¡Œ Hugo æ§‹å»ºå‘½ä»¤
echo "â–¶ åŸ·è¡Œ Hugo å‘½ä»¤: hugo..."
hugo

# 3. æ§‹å»ºå®Œæˆå¾Œï¼ŒåŸ·è¡Œæ¸…ç† (å¦‚æœè¨­ç½®äº† SKIP_CLEANUP=1ï¼Œå‰‡åœ¨é€™è£¡é¡¯å¼èª¿ç”¨)
if [ "$SKIP_CLEANUP" == "1" ]; then
    cleanup_indexes
fi

echo "âœ… æ§‹å»ºæµç¨‹çµæŸã€‚"